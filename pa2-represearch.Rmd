---
title: "Peer Assessment 2"
author: "Saurabh"
date: "Friday, February 20, 2015"
output: html_document
---

## Synopsis
This document is a compilation of the analysis of the storm dataset generated by NOAA. The document goes through the process of downloading, processing and analyzing the data to create graphs and make inferences.This document addresses the question of which events are economically and socially harmful to human beings.


## Data Processing
The data processing during the course of the analysis was fairly straightforward.
The data was downloaded from the link on the coursera site and unzipped in the same folder, without overwriting.The dataset was subsetted to include only those columns pertinent for the analysis.


EVTYPE- Contains labels for the event types


FATALITIEs- The number of deaths caused directly due to an event


INJURIES- The number of injuries caused directly due to an event


PROPDMG- The coefficient of damage caused to property due to an event


PROPDMGEXP- The exponent of damage caused to property due to an event


CROPDMG- The coefficient of damage caused to crops due to an event


CROPDMGEXP- The exponent of damage caused to crops due to an event


The steps involved in the processing are


* The injuries and fatalities were grouped by event
* All events that caused no injuries or fatalities were removed 
* The event types were converted to uppercase and aggregated again to remove duplicates
* The fatalities and injuries were matched to check the number of values lost, the data seems good enough to continue
* The injuries and fatalities were aggregated on EVTYPE and the missed values tabulated


```{r,warning=FALSE,echo=TRUE,message=FALSE}
setwd("~/Coursera Stuff/represearch")
require(gridExtra)
require(lattice)
require(ggplot2)
library(R.utils)
if(!file.exists("~/Coursera Stuff/represearch/repdata-data-StormData.csv.bz2")){
download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2","~/Coursera Stuff/represearch/repdata-data-StormData.csv.bz2",method="curl")
}
if(!file.exists("~/Coursera Stuff/represearch/repdata-data-StormData.csv")){
bunzip2(filename="~/Coursera Stuff/represearch/repdata-data-StormData.csv.bz2",destname="~/Coursera Stuff/represearch/repdata-data-StormData.csv",overwrite=FALSE,remove=FALSE)
}
data<-read.csv("repdata-data-StormData.csv")


sub<-data[,c(8,23,24,25,26,27,28)]
injuries<-aggregate(sub$INJURIES,list(sub$EVTYPE),sum)
fatalities<-aggregate(sub$FATALITIES,list(sub$EVTYPE),sum)
fatalities<-fatalities[fatalities[,2]>0,]
injuries<-injuries[injuries[,2]>0,]
fatalities[,1]<-toupper(fatalities[,1])
fatalities<-aggregate(fatalities[,2],list(fatalities[,1]),sum)
injuries[,1]<-toupper(injuries[,1])
injuries<-aggregate(injuries[,2],list(injuries[,1]),sum)
injuries$match<-injuries[,1] %in% fatalities[,1]
fatalities$match<-fatalities[,1] %in% injuries[,1]
aggregate(fatalities[,2],list(fatalities$match),sum)
aggregate(injuries[,2],list(injuries$match),sum)
merged<-merge(fatalities,injuries,by="Group.1")
names(merged)<-c("EVTYPE","FATALITIES","FAT.MATCH","INJURIES","INJ.MATCH")

```


Most deaths and injuries seem accounted for [True for accounted and False for unaccounted]. The process was done to ensure consistency accross labels


##  First Question [harm to human life]


```{r,echo=TRUE,warning=FALSE}
plot1<-xyplot(FATALITIES~INJURIES,data=merged,pch='*',cex=2,main="FATALITIES VS. INJURIES by EVTYPE",xlab="FATALITIES",ylab="INJURIES")
bar1<-merged[with(merged, order(-merged$FATALITIES)), ][c(1:10),]
plot2<-barchart(factor(bar1$EVTYPE,levels=unique(as.character(bar1$EVTYPE)))~bar1$FATALITIES,main="TOP 10 INJURIES BY EVENT",xlab="FATALITIES",ylab="EVENT")
bar2<-merged[with(merged, order(-merged$INJURIES)), ][c(1:10),]
plot3<-barchart(factor(bar2$EVTYPE,levels=unique(as.character(bar2$EVTYPE)))~bar2$INJURIES,col="red",main="TOP 10 FATALITIES BY EVENT",xlab="INJURIES",ylab="EVENT")
grid.arrange(plot1,plot2,plot3,ncol=2)
```


We can see that there is one obvious outlier in terms of injuries and fatalities, far more than any other event, the barcharts show that the event is 'TORNADOES'

## Second Question  [crop and property damage]


```{r,echo=TRUE,warning=FALSE}
converter <- function(dataset = storm, fieldName, newFieldName) {
  totalLen <- dim(dataset)[2]
  index <- which(colnames(dataset) == fieldName)
  dataset[, index] <- as.character(dataset[, index])
  logic <- !is.na(toupper(dataset[, index]))
  dataset[logic & toupper(dataset[, index]) == "B", index] <- "9"
  dataset[logic & toupper(dataset[, index]) == "M", index] <- "6"
  dataset[logic & toupper(dataset[, index]) == "K", index] <- "3"
  dataset[logic & toupper(dataset[, index]) == "H", index] <- "2"
  dataset[logic & toupper(dataset[, index]) == "", index] <- "0"
  dataset[, index] <- as.numeric(dataset[, index])
  dataset[is.na(dataset[, index]), index] <- 0
  dataset <- cbind(dataset, dataset[, index - 1] * 10^dataset[, index])
  names(dataset)[totalLen + 1] <- newFieldName
  return(dataset)
}

sub <- converter(sub, "PROPDMGEXP", "propertyDamage")
sub <- converter(sub, "CROPDMGEXP", "cropDamage")
```


That added propertyDamage and cropDamage as two columns that evaluated total crop and property damage caused by the event in terms of U.S Dollars. We can see that the PROPDMGEXP and CROPDMGEXP fields are cleaned up and characters for exponential values are substituted by numbers.

```{r}
property<-aggregate(sub$propertyDamage,list(sub$EVTYPE),sum)
names(property)<-c("EVTYPE","PROPERTY")
property<-property[with(property,order(-PROPERTY)),][c(1:10),]
crops<-aggregate(sub$cropDamage,list(sub$EVTYPE),sum)
names(crops)<-c("EVTYPE","CROP")
crops<-crops[with(crops,order(-CROP)),][c(1:10),]
propertyPlot <- qplot(factor(EVTYPE,levels=unique(as.character(EVTYPE))), data = property, weight = PROPERTY, geom = "bar", binwidth = 1) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + scale_y_continuous("Property Damage in US dollars")+ 
  xlab("Event Type") + ggtitle("Total Property Damage by Event")
cropPlot<-qplot(factor(EVTYPE,levels=unique(as.character(EVTYPE))), data = crops, weight = CROP, geom = "bar", binwidth = 1) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + scale_y_continuous("Crop Damage in US dollars") + 
  xlab("Event Type") + ggtitle("Total Crop Damage by Event")
grid.arrange(propertyPlot, cropPlot, ncol = 2)
```


## Results


The result of the analysis is that the particular events tend to be the most destructive in a particular catefory by a large margin when compared to others. Tornadoes cause the most harm to human life as they cause the most number of injuries and fatalitites by a large margin. Similarly, Droughts cause the most damage to crops, which is an intuitive guess to make as they are widespread and accross geographies. Floods cause the most damage to property, generally in cities along riverbanks or near the coast, where flash flooding is a problem. 